<?php

declare(strict_types=1);

namespace App\Views\Content\Accreditation;

use App\Config\AdminConfig;
use App\Config\AppConfig;
use App\Controllers\Pages\AccreditationController;
use App\Services\Accreditation\AccreditationUtility;
use App\Services\Accreditation\Enum\ExamType;

class AccreditationAdminViewContent
{
    const HIDDEN_USER_ID = [
        1, 2
    ];

    public string $examTypeName;
    public string $typeColor;

    function __construct(
        public AccreditationController $controller,
    ) {
        $this->examTypeName = match ($this->controller->type) {
            ExamType::Bronze => '„Éñ„É≠„É≥„Ç∫',
            ExamType::Silver => '„Ç∑„É´„Éê„Éº',
            ExamType::Gold => '„Ç¥„Éº„É´„Éâ',
        };

        $this->typeColor = match ($this->controller->type) {
            ExamType::Bronze => '#ac6b25',
            ExamType::Silver => '#808080',
            ExamType::Gold => '#e6b422',
        };
    }

    function head()
    {
        self::headComponent($this->examTypeName);
    }

    static function headComponent(?string $subTitle = null, ?bool $sakuraCss = false)
    { ?>

        <head prefix="og: http://ogp.me/ns#">
            <?php echo gTag(AppConfig::GTM_ID) ?>
            <meta charset="UTF-8">
            <meta http-equiv="X-UA-Compatible" content="IE=edge">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>„Ç™„Éó„ÉÅ„É£Ê§úÂÆö<?php if ($subTitle) echo 'ÔΩú' . $subTitle ?>ÔΩúÂïèÈ°åÊäïÁ®ø„Éö„Éº„Ç∏</title>
            <meta name="description" content="„Åì„Åì„Åã„ÇâË™∞„Åß„ÇÇ„Ç™„Éó„ÉÅ„É£Ê§úÂÆö„Å´ÂïèÈ°å„ÇíÊäïÁ®ø„Åß„Åç„Åæ„Åô„ÄÇ">
            <meta property="og:locale" content="ja_JP">
            <meta property="og:url" content="<?php echo url(path()) ?>">
            <meta property="og:type" content="website">
            <meta property="og:title" content="„Ç™„Éó„ÉÅ„É£Ê§úÂÆö<?php if ($subTitle) echo 'ÔΩú' . $subTitle ?>ÔΩúÂïèÈ°åÊäïÁ®ø„Éö„Éº„Ç∏">
            <meta property="og:description" content="„Ç™„Éó„ÉÅ„É£Ê§úÂÆö„ÅØ„ÄÅLINE„Ç™„Éº„Éó„É≥„ÉÅ„É£„ÉÉ„Éà„ÅÆÂà©Áî®„Å´Èñ¢ÈÄ£„Åô„ÇãÁü•Ë≠ò„ÇíÊ∑±„ÇÅ„ÇãÂ†¥ÊâÄ„Åß„Åô„ÄÇ„Ç¨„Ç§„Éâ„É©„Ç§„É≥„ÄÅ„É´„Éº„É´„ÄÅÁÆ°ÁêÜÊñπÊ≥ï„Å™„Å©„Å´„Å§„ÅÑ„Å¶Ê•Ω„Åó„ÅèÂ≠¶„Å∂„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇÂïèÈ°åÊäïÁ®ø„Éö„Éº„Ç∏„Åß„ÅØË™∞„Åß„ÇÇÂïèÈ°å„ÇíÊäïÁ®ø„Åß„Åç„ÄÅ‰ªñ„ÅÆ‰∫∫„ÅåÊäïÁ®ø„Åó„ÅüÂïèÈ°å„ÇíÈñ≤Ë¶ß„Åß„Åç„Åæ„Åô„ÄÇËá™ÂàÜ„ÅÆÁü•Ë≠ò„ÇíÂÖ±Êúâ„Åó„Å¶„ÄÅ„Ç™„Éº„Éó„É≥„ÉÅ„É£„ÉÉ„Éà„Ç≥„Éü„É•„Éã„ÉÜ„Ç£„Å´Ë≤¢ÁåÆ„Åß„Åç„Åæ„ÅôÔºÅ">
            <meta property="og:site_name" content="„Ç™„Éó„ÉÅ„É£„Ç∞„É©„Éï">
            <meta property="og:image" content="<?php echo fileUrl('assets/ogp-accreditation.png') ?>">
            <meta name="twitter:card" content="summary_large_image">
            <link rel="icon" type="image/png" href="<?php echo fileUrl('assets/study_icon.png') ?>">
            <?php if ($sakuraCss) : ?>
                <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sakura.css/css/sakura-earthly.css" type="text/css">
            <?php else : ?>
                <link rel="stylesheet" href="<?php echo fileUrl('style/mvp.css') ?>">
            <?php endif ?>
            <link rel="canonical" href="<?php echo url(path()) ?>">
            <meta name="thumbnail" content="<?php echo fileUrl('assets/ogp-accreditation.png') ?>" />
        </head>
    <?php
    }

    function header()
    { ?>
        <header style="padding-bottom: 1rem; margin-bottom: 0rem;">
            <style>
                @media screen and (max-width: 511px) {
                    nav ul li {
                        display: list-item;
                    }

                    body header,
                    main,
                    footer {
                        padding-top: 0;
                    }

                    .header-nav-ul li {
                        margin-right: 1rem;
                    }
                }


                nav a b {
                    margin: 0;
                    padding: 4px;
                    border: 1px solid <?php echo $this->typeColor ?>;
                    font-size: 13px;
                    background-color: #fff;
                    color: #000;
                }

                hr {
                    border-bottom: 1px #efefef solid;
                    margin: 2rem 0;
                }

                section aside {
                    width: 100%;
                    margin: 1rem 0;
                }

                .header-nav-ul {
                    margin-bottom: 0;
                }

                .header-nav-ul li {
                    text-wrap: nowrap;
                    white-space: nowrap;
                    padding-bottom: 6px;
                }

                .header-nav-left {
                    margin-right: 1rem;
                    width: 100%;
                    max-width: 240px;
                    padding: 0 1rem;
                }

                .header-nav-a {
                    display: block;
                    text-decoration: none;
                }

                .header-nav-title {
                    color: #000;
                    font-weight: normal;
                    font-size: 14px;
                    text-wrap: nowrap;
                    white-space: nowrap;
                    margin-top: 10px;
                }

                .header-nav-a img {
                    margin: 0;
                }

                .nav-user-name-link {
                    font-size: 13px;
                    color: #000;
                    text-decoration: none;
                }

                .nav-li-user-name {
                    display: none;
                }

                .nav-left-user-name {
                    margin-bottom: 16px;
                    line-height: 1;
                    text-align: right;
                }

                .header-logo {
                    display: block;
                }

                @media screen and (max-width: 360px) {
                    .header-nav-title {
                        font-size: 13px;
                        text-wrap: unset;
                        white-space: unset;
                    }
                }

                @media screen and (min-width: 512px) {
                    .header-nav-left {
                        max-width: 200px;
                        margin: 0;
                    }

                    .nav-li-user-name {
                        display: inline-block;
                    }

                    .nav-left-user-name {
                        display: none;
                    }
                }
            </style>
            <nav style="margin-bottom: 0">
                <div class="header-nav-left">
                    <?php if ($this->controller->profileArray) : ?>
                        <div class="nav-left-user-name">
                            <a class="nav-user-name-link" href="./profile">
                                <?php if ($this->controller->profileArray['is_admin']) : ?>
                                    üëë
                                <?php endif ?>
                                <span style="text-decoration: underline;"> <?php echo $this->controller->profileArray['name'] ?></span>
                            </a>
                        </div>
                    <?php endif ?>
                    <a class="header-nav-a" href="./home">
                        <img class="header-logo" src="<?php echo fileUrl('assets/accreditation-log.svg') ?>" />
                        <div class="header-nav-title">
                            <span>ÂïèÈ°åÊäïÁ®ø„Éö„Éº„Ç∏</span>
                        </div>
                    </a>
                </div>
                <ul class="header-nav-ul">
                    <?php foreach ([
                        'home' => '„Éõ„Éº„É†',
                        'question' => 'ÂïèÈ°å„ÇíÊäïÁ®ø',
                        'user' => 'ÊäïÁ®ø„Åó„ÅüÂïèÈ°å',
                        'member' => '„É°„É≥„Éê„Éº',
                    ] as $key => $value) : ?>
                        <?php if ($key === 'user') : ?>
                            <?php if (
                                $this->controller->pageType === 'user'
                                && $this->controller->myId === $this->controller->currentId
                            ) : ?>
                                <li><b><?php echo $value ?></b></li>
                            <?php else : ?>
                                <li><a href="./user?id=<?php echo $this->controller->myId ?>"><?php echo $value ?></a></li>
                            <?php endif ?>
                        <?php elseif ($key !== $this->controller->pageType) : ?>
                            <li><a href="./<?php echo $key ?>"><?php echo $value ?></a></li>
                        <?php else : ?>
                            <li><b><?php echo $value ?></b></li>
                        <?php endif ?>
                    <?php endforeach ?>
                    <?php if ($this->controller->profileArray) : ?>
                        <li class="nav-li-user-name">
                            <a class="nav-user-name-link" href="./profile">
                                <?php if ($this->controller->profileArray['is_admin']) : ?>
                                    üëë
                                <?php endif ?>
                                <span style="text-decoration: underline;"> <?php echo $this->controller->profileArray['name'] ?></span>
                            </a>
                        </li>
                    <?php endif ?>
                </ul>
            </nav>
        </header>
    <?php
    }

    private function tabStyle()
    { ?>
        <style>
            .main-tab {
                display: flex;
                gap: 1rem;
            }

            .main-tab a i,
            .main-tab a b {
                padding: 12px 10px;
                word-break: keep-all
            }

            @media screen and (max-width: 511px) {
                .main-tab {
                    gap: 12px;
                }

                .main-tab a i,
                .main-tab a b {
                    padding: 12px 6px;
                    font-size: 14px;
                }
            }

            @media screen and (max-width: 359px) {
                .main-tab {
                    gap: 8px;
                }

                .main-tab a i,
                .main-tab a b {
                    padding: 12px 6px;
                    font-size: 14px;
                }
            }
        </style>
    <?php
    }

    function mainTab()
    { ?>
        <?php $this->tabStyle() ?>
        <div class="main-tab">
            <?php foreach ([
                ['Êú™ÂÖ¨Èñã„ÅÆ<wbr>ÂïèÈ°å', 'unpublished'],
                ['Âá∫È°å‰∏≠„ÅÆ<wbr>ÂïèÈ°å', 'published'],
                ['ÊäïÁ®øËÄÖ„ÅÆ<wbr>‰∏ÄË¶ß', 'contributors'],
            ] as $p) : ?>
                <?php if ($this->controller->pageType === $p[1]) : ?>
                    <a><i><?php echo $p[0] ?></i></a>
                <?php else : ?>
                    <a href="./<?php echo $p[1] ?>"><b><?php echo $p[0] ?></b></a>
                <?php endif ?>
            <?php endforeach ?>
        </div>
        <?php $this->typeTab() ?>
    <?php
    }

    function typeTab()
    { ?>
        <style>
            .type-tab {
                margin: 20px 0 24px 0;
                font-size: 16px;
                font-weight: bold;
                display: flex;
                gap: 20px;
            }

            @media screen and (min-width: 512px) {
                .type-tab {
                    margin: 20px 0 3rem 0;
                    font-size: 18px;
                    font-weight: bold;
                    display: flex;
                    gap: 20px;
                }
            }
        </style>
        <div class="type-tab">
            <?php foreach ([
                'bronze' => '„Éñ„É≠„É≥„Ç∫',
                'silver' => '„Ç∑„É´„Éê„Éº',
                'gold' => '„Ç¥„Éº„É´„Éâ',
            ] as $key => $value) : ?>
                <?php if ($key !== $this->controller->type->value) : ?>
                    <?php if ($this->controller->pageType === 'user') : ?>
                        <a href="./../<?php echo $key . "/user?id=" . $this->controller->currentId ?>"><?php echo $value ?></a>
                    <?php else : ?>
                        <a href="./../<?php echo $key . "/" . $this->controller->pageType ?>"><?php echo $value ?></a>
                    <?php endif ?>
                <?php else : ?>
                    <b><?php echo $value ?></b>
                <?php endif ?>
            <?php endforeach ?>
        </div>
    <?php
    }

    function examTitle()
    {
    ?>
        <span style="margin-left: 6px; font-size: 15px; color: <?php echo $this->typeColor ?>;"><?php echo $this->examTypeName ?></span>
    <?php
    }

    function profile(bool $currentProfile = false)
    {
        $profile = $currentProfile ? $this->controller->currentProfileArray : $this->controller->profileArray;
        if (!$profile) {
            return;
        }

    ?>
        <section style="position: relative;">
            <aside>
                <?php if (
                    in_array($this->controller->myId, AdminConfig::ACCREDITATION_TRUE_ADMIN_USER_ID)
                    && !in_array($profile['id'], AdminConfig::ACCREDITATION_TRUE_ADMIN_USER_ID)
                ) : ?>
                    <?php $this->adminProfileForm() ?>
                <?php endif ?>
                <p><small><b>„Éã„ÉÉ„ÇØ„Éç„Éº„É†</b><br><?php echo $profile['name'] ?></small></p>
                <?php if ($profile['url']) : ?>
                    <p>
                        <small>
                            <b>„Ç™„Éº„Éó„É≥„ÉÅ„É£„ÉÉ„Éà</b><br>
                            <a href="<?php echo $profile['url'] ?>"><?php echo $profile['room_name'] ?></a>
                        </small>
                    </p>
                <?php endif ?>
                <?php if ($profile['is_admin']) : ?>
                    <small>üëë„Çµ„Ç§„ÉàÁÆ°ÁêÜËÄÖ</small>
                <?php endif ?>
            </aside>
        </section>
    <?php
    }

    function adminProfileForm()
    {
        $profile = $this->controller->currentProfileArray;
        $isAdmin = $profile['is_admin'];
        $returnTo = "?return_to=/accreditation/{$this->controller->type->value}/user?id=" . $profile['id'];

    ?>
        <form style="all:unset; display: block; position:absolute; top:2.25rem; right:1.25rem;" onsubmit="return confirm('<?php echo $isAdmin ? 'ÁÆ°ÁêÜËÄÖ„ÇíËß£Èô§„Åó„Åæ„Åô„ÅãÔºü' : 'ÁÆ°ÁêÜËÄÖ„Å´Ë®≠ÂÆö„Åó„Åæ„Åô„ÅãÔºü' ?>')" method="POST" action="/accreditation/set-admin-permission<?php echo $returnTo ?>">
            <input type="hidden" value="<?php echo $profile['id'] ?>" name="id">
            <input type="hidden" value="<?php echo $isAdmin ? 0 : 1 ?>" name="is_admin">
            <input type="submit" value="<?php echo $isAdmin ? 'ÁÆ°ÁêÜËÄÖ„ÇíËß£Èô§' : 'ÁÆ°ÁêÜËÄÖ„Å´Ë®≠ÂÆö' ?>" style="padding: 3px 6px; font-size: 13px; margin: 0;" />
        </form>
    <?php
    }

    function contributors()
    {
    ?>
        <?php foreach ($this->controller->currentContributorsArray as $p) : ?>
            <?php if (in_array($p['id'], self::HIDDEN_USER_ID)) continue ?>
            <section>
                <aside style="margin: 0.5rem 0;">
                    <div style="margin-bottom: 12px;">
                        <div style="margin-bottom: 4px;"><small>„Éã„ÉÉ„ÇØ„Éç„Éº„É†</small></div>
                        <div>
                            <a style="color: #111;" href="./user?id=<?php echo $p['id'] ?>"><?php echo $p['name'] ?></a>
                        </div>
                    </div>
                    <?php if ($p['url']) : ?>
                        <div style="margin-bottom: 12px;">
                            <div style="margin-bottom: 4px;"><small>„Ç™„Éº„Éó„É≥„ÉÅ„É£„ÉÉ„Éà</small></div>
                            <div> <a style="color: #111;" href="<?php echo $p['url'] ?>"><?php echo $p['room_name'] ?></a></div>
                        </div>
                    <?php endif ?>
                    <?php if ($p['is_admin']) : ?>
                        <small>üëë„Çµ„Ç§„ÉàÁÆ°ÁêÜËÄÖ</small>
                    <?php endif ?>
                </aside>
            </section>
        <?php endforeach ?>
    <?php
    }

    function profileTerm()
    {
    ?>
        <p>
            <?php if (!$this->controller->profileArray) : ?>
                <small>„Éó„É≠„Éï„Ç£„Éº„É´„Çí‰ΩúÊàê„Åô„Çã„Å®„É°„É≥„Éê„Éº‰∏ÄË¶ß„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ</small>
                <br>
            <?php endif ?>
            <small>ÂïèÈ°å„ÅåÊ§úÂÆö„Å´Âá∫È°å„Åï„Çå„ÅüÈöõ„ÅØ„ÄÅÂá∫È°åËÄÖ„Å®„Åó„Å¶„Éã„ÉÉ„ÇØ„Éç„Éº„É†„Å®„Ç™„Éó„ÉÅ„É£Âêç„Éª„Ç™„Éó„ÉÅ„É£„É™„É≥„ÇØ„ÅåÊ§úÂÆö„Çµ„Ç§„Éà‰∏ä„Å´Êé≤Ëºâ„Åï„Çå„Åæ„Åô„ÄÇ</small>
        </p>
    <?php
    }

    function term()
    {
    ?>
        <p>
            <small>„Åì„ÅÆ„Çµ„Ç§„Éà„Åß„ÅØ„Ç™„Éó„ÉÅ„É£Ê§úÂÆö„ÅÆÂïèÈ°åÈõÜ„ÇíÁÆ°ÁêÜ„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ<br>LINE„É≠„Ç∞„Ç§„É≥„Åß„É°„É≥„Éê„ÉºÁôªÈå≤„ÇíË°å„ÅÑ„ÄÅË™∞„Åß„ÇÇÂïèÈ°åÊñá„ÇíÊäïÁ®ø„Åó„Å¶‰ΩúÊàê„Å´ÂçîÂäõ„Åô„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ</small>
        </p>
        <?php echo $this->profileTerm() ?>
        <p>
            <small>ÊäïÁ®ø„Åï„Çå„ÅüÂïèÈ°å„ÅØ„ÄÅÊ§úÂÆö„Å´Âêà„Çè„Åõ„Çã„Åü„ÇÅ„Å´„Çµ„Ç§„ÉàÁÆ°ÁêÜËÄÖ„ÅåÁ∑®ÈõÜ„Åô„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ<br>ÂïèÈ°åÊï∞„ÅåÈôê„Çâ„Çå„Å¶„ÅÑ„Çã„ÅÆ„Åß„ÄÅÂÆüÈöõ„Å´Âá∫È°å„Åï„Çå„Çã„ÅÆ„ÅØ‰∏ÄÈÉ®„ÅÆÁØÑÂõ≤„ÅÆÂïèÈ°å„Å®„Å™„Çä„Åæ„Åô„ÄÇ</small>
        </p>
    <?php
    }

    function termHome()
    {
    ?>
        <p>
            <small>„Åì„ÅÆ„Çµ„Ç§„Éà„Åß„ÅØ„Ç™„Éó„ÉÅ„É£Ê§úÂÆö„ÅÆÂïèÈ°åÈõÜ„ÇíÁÆ°ÁêÜ„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ</small>
        </p>
        <?php $this->userTerm() ?>
        <?php $this->profileTerm() ?>
    <?php
    }

    function userTerm()
    {
    ?>
        <p>
            <small>ÊäïÁ®ø„Åï„Çå„ÅüÂïèÈ°å„ÅØ„ÄÅÊ§úÂÆö„Å´Âêà„Çè„Åõ„Çã„Åü„ÇÅ„Å´„Çµ„Ç§„ÉàÁÆ°ÁêÜËÄÖ„ÅåÁ∑®ÈõÜ„Åô„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ<br>ÂïèÈ°åÊï∞„ÅåÈôê„Çâ„Çå„Å¶„ÅÑ„Çã„ÅÆ„Åß„ÄÅÂÆüÈöõ„Å´Âá∫È°å„Åï„Çå„Çã„ÅÆ„ÅØ‰∏ÄÈÉ®„ÅÆÁØÑÂõ≤„ÅÆÂïèÈ°å„Å®„Å™„Çä„Åæ„Åô„ÄÇ</small>
        </p>
    <?php
    }

    function termQ()
    {
    ?>
        <p>
            <small>ÊäïÁ®ø„Åó„ÅüÂïèÈ°å„ÅØÊú™ÂÖ¨Èñã„ÅÆÁä∂ÊÖã„Åß„Çµ„Ç§„Éà‰∏ä„Å´‰øùÂ≠ò„Åï„Çå„Åæ„Åô„ÄÇ<br>„ÄåÊäïÁ®ø„Åó„ÅüÂïèÈ°å„Äç„Åã„ÇâÁ∑®ÈõÜ„Åô„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ<br>„Çµ„Ç§„ÉàÁÆ°ÁêÜËÄÖ„Å´„Çà„ÇäÂá∫È°å‰∏≠„Å´„Å™„Å£„ÅüÂ†¥Âêà„ÅØ„ÄÅÂÆüÈöõ„ÅÆÊ§úÂÆö„ÅßË°®Á§∫„Åï„Çå„ÇãÁä∂ÊÖã„Å´„Å™„Çä„Åæ„Åô„ÄÇ</small>
        </p>
    <?php
    }

    function termEditor()
    {
    ?>
        <p>
            <small>„Çµ„Ç§„ÉàÁÆ°ÁêÜËÄÖ„ÅåÁ∑®ÈõÜ„Åó„ÅüÂæå„ÅØ„ÄÅ‰ªñ„ÅÆ„É°„É≥„Éê„Éº„ÅØÁ∑®ÈõÜ„Åß„Åç„Å™„Åè„Å™„Çä„Åæ„Åô„ÄÇ</small>
        </p>
    <?php
    }

    function footer($scrollBtn = true)
    {
    ?>
        <footer>
            <?php if (in_array($this->controller->pageType, ['login', 'home'])) : ?>
                <hr style="margin-top: 0rem;">
                <p>
                    <small>„Åì„ÅÆ„Çµ„Ç§„Éà„ÅØLINE„Ç™„Éº„Éó„É≥„ÉÅ„É£„ÉÉ„ÉàÈùûÂÖ¨Âºè„Åß„Åô„ÄÇLINE„É§„Éï„ÉºÁ§æ„ÅØ„Åì„ÅÆÂÜÖÂÆπ„Å´Èñ¢‰∏é„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ<br>Áõ£‰øÆ„Åó„Å¶„ÅÑ„Çã„ÅÆ„ÅØ‰∏ÄÈÉ®„ÅÆLINE„Ç™„Éº„Éó„É≥„ÉÅ„É£„ÉÉ„ÉàÂÖ¨Ë™ç„É°„É≥„Çø„Éº„Åß„Åô„ÄÇ</small>
                </p>
            <?php elseif ($scrollBtn) : ?>
                <small style="text-decoration: underline; color: #111; cursor:pointer; display:block; margin-left: auto; width:fit-content;" onclick="window.scroll({top: 0,behavior:'smooth'})">‚Üë ‰∏ÄÁï™‰∏ä„Åæ„Åß„Çπ„ÇØ„É≠„Éº„É´</small>
                <br>
            <?php endif ?>
            <small><a href="/accreditation/privacy" style="color: #b7b7b7; text-decoration: none;">„Éó„É©„Ç§„Éê„Ç∑„Éº„Éù„É™„Ç∑„Éº</a></small>
            <small><a href="/policy/term" style="color: #b7b7b7; text-decoration: none; margin-left: 1rem;">Âà©Áî®Ë¶èÁ¥Ñ</a></small>
        </footer>
    <?php
    }

    function questionForm(string $returnTo, bool $editorMode = false)
    {
        $q = null;
        if ($editorMode && isset($this->controller->questionList[0])) {
            $q = $this->controller->questionList[0];
        }

        if ($editorMode) {
            $action = "edit-question";
            $confirm = 'Â§âÊõ¥„Åó„Åæ„Åô„ÅãÔºü';
            $submit = 'Â§âÊõ¥';
        } else {
            $action = "register-question";
            $confirm = 'ÁôªÈå≤„Åó„Åæ„Åô„ÅãÔºü';
            $submit = 'ÁôªÈå≤';
        }
    ?>
        <form style="user-select:none; margin-top: 0.5rem;" id="q-form" onsubmit="return confirm('<?php echo $confirm ?>')" id="user-form" method="POST" action="/accreditation/<?php echo $action . $returnTo ?>">
            <label for="q_text">ÂïèÈ°åÊñá</label>
            <textarea id="q_text" name="question" maxlength="4000" rows="5" required><?php echo $q->question ?? '' ?></textarea>

            <?php foreach (range('a', 'd') as $key => $el) : ?>
                <div style="display: flex; gap: 1rem;">
                    <label for="answer_<?php echo $key ?>">ÂõûÁ≠î <?php echo strtoupper($el) ?></label>
                    <div style="user-select: none;">
                        <input id="radio_<?php echo $key ?>" type="radio" name="answers[correct]" value="<?php echo $el ?>" style="transform:scale(1.5); cursor: pointer;" required <?php if (($q->answersArray['correct'] ?? '') === $el) echo 'checked' ?>>
                        <label for="radio_<?php echo $key ?>" style="cursor: pointer;">Ê≠£Ëß£</label>
                    </div>
                </div>
                <textarea id="answer_<?php echo $key ?>" name="answers[<?php echo $el ?>]" maxlength="4000" rows="3" required><?php echo $q->answersArray[$el] ?? '' ?></textarea>
            <?php endforeach ?>

            <label for="explanation">Ëß£Ë™¨ÔºàÂøÖÈ†àÔºâ</label>
            <textarea id="explanation" name="explanation" maxlength="4000" rows="5" required><?php echo $q->explanationArray['explanation'] ?? '' ?></textarea>

            <fieldset>
                <legend style="font-weight: bold;">Âá∫ÂÖ∏URLÔºàÂøÖÈ†àÔºâ</legend>
                <p>ÂõûÁ≠î„ÅÆÊ†πÊã†„Å´„Å™„ÇãURL„ÇíÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                <div style="margin-bottom: 1rem; display:flex; align-items: center">
                    <div>
                        <input id="radio_url1" type="radio" name="source_url" value="" style="transform:scale(1.5); margin-bottom: 0; cursor: pointer;" required <?php if ($q && !($q->explanationArray['source_url'] ?? '')) echo 'checked' ?>>
                        <label style="display: inline-block; user-select:none; cursor: pointer;" for="radio_url1">ÂÆâÂøÉ„ÉªÂÆâÂÖ®„Ç¨„Ç§„Éâ„É©„Ç§„É≥</label>
                    </div>
                    <a style="text-wrap: nowrap; margin-left:1rem; font-size: 13px;" href="https://openchat-jp.line.me/other/guideline" target="_blank">Èñã„Åè‚Üó</a>
                </div>
                <div>
                    <input id="radio_url2" type="radio" name="source_url" value="<?php if ($q && ($q->explanationArray['source_title'] ?? '')) echo $q->explanationArray['source_url'] ?? '' ?>" style="transform:scale(1.5); cursor: pointer;" required <?php if ($q && ($q->explanationArray['source_title'] ?? '')) echo 'checked' ?>>
                    <label for="radio_url2" style="cursor: pointer;">URL„ÇíÂÖ•Âäõ</label>
                </div>
                <small id="url-message" style="display: none;">URL„ÅåÁÑ°Âäπ„Åß„Åô</small>
                <input style="display: block; margin-bottom: 0;" type="text" id="source_url" maxlength="4000" value="<?php if ($q && ($q->explanationArray['source_title'] ?? '')) echo $q->explanationArray['source_url'] ?? '' ?>">
                <small style="user-select: none;">URL„ÅØLINEÂÖ¨ÂºèÈñ¢ÈÄ£„ÅÆ„Éö„Éº„Ç∏„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</small>
            </fieldset>

            <input type="hidden" value="<?php echo $this->controller->type->value ?>" name="type">

            <?php if ($editorMode) : ?>
                <input type="hidden" value="<?php echo $this->controller->currentId ?>" name="id">

                <?php if ($this->controller->isAdmin) : ?>
                    <br>
                    <label for="publishing">ÂÖ¨ÈñãË®≠ÂÆö</label>
                    <select name="publishing" id="publishing" style="cursor: pointer;">
                        <option value="0" <?php if (($q->publishing ?? '') === 0) echo 'selected' ?>>Êú™ÂÖ¨Èñã</option>
                        <option value="1" <?php if (($q->publishing ?? '') === 1) echo 'selected' ?>>Âá∫È°å‰∏≠</option>
                    </select>
                    <br>
                <?php endif ?>
            <?php endif ?>

            <br>
            <small style="display:block;">ÂÄã‰∫∫ÊÉÖÂ†±„ÅÆÊäïÁ®ø„ÅØÁ¶ÅÊ≠¢„Åß„Åô„ÄÇ</small>
            <input id="submit-btn" type="submit" value="<?php echo $submit ?>" />
        </form>
        <script type="module">
            import {
                UrlValidator
            } from '<?php echo fileUrl('/js/UrlValidator.js') ?>';

            const radioUrl1 = document.getElementById('radio_url1')
            const radioUrl2 = document.getElementById('radio_url2')
            const sorceUrl = document.getElementById('source_url')
            const submit = document.getElementById('submit-btn')
            const urlMessage = document.getElementById('url-message')
            const qForm = document.getElementById('q-form')

            const inputValidator = new UrlValidator(
                sorceUrl, urlMessage, submit
            )

            const radioUrlChange = () => {
                sorceUrl.required = radioUrl2.checked
                submit.disabled = radioUrl2.checked
                radioUrl2.checked && inputValidator.handle()
            }

            radioUrl1.addEventListener('change', radioUrlChange)
            radioUrl2.addEventListener('change', radioUrlChange)

            sorceUrl.addEventListener('input', () => {
                const value = sorceUrl.value.trim()
                sorceUrl.value = value
                radioUrl2.value = value
                radioUrl2.checked = true
                inputValidator.handle()
            })

            submit.addEventListener('click', () => {
                ['question', 'answer_0', 'answer_1', 'answer_2', 'answer_3', 'explanation'].map(key => {
                    qForm[key].value = qForm[key].value.trim()
                })

                if (qForm['answers[correct]'].value || !qForm['question'].value)
                    return

                qForm.scrollIntoView({
                    behavior: 'smooth'
                });
            })
        </script>
    <?php
    }

    function deleteQuestionForm(string $returnTo)
    {
        if (!isset($this->controller->questionList[0]))
            return;

        $q = $this->controller->questionList[0];
    ?>
        <form style="display:flex; flex-direction: row-reverse;" onsubmit="return confirm('ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ')" method="POST" action="/accreditation/delete-question<?php echo $returnTo ?>">
            <input type="hidden" value="<?php echo $q->id ?>" name="id">
            <input type="submit" value="ÂâäÈô§" style="padding: 10px 20px; background-color:#e2326b; border-color:#e2326b;" />
        </form>
    <?php
    }

    function adminQuestionForm(string $returnTo, string $deleteReturnTo)
    {
        if (!isset($this->controller->questionList[0]) || !$this->controller->isAdmin)
            return;

        $q = $this->controller->questionList[0];
    ?>
        <section>
            <aside>
                <b>„Çµ„Ç§„ÉàÁÆ°ÁêÜËÄÖÊ©üËÉΩ</b>
                <hr>
                <form style="all:unset; display: block;" onsubmit="return confirm('Ê§úÂÆö„É¨„Éô„É´„ÇíÁßªÂãï„Åó„Åæ„Åô„ÅãÔºü')" method="POST" action="/accreditation/move-question">
                    <input type="hidden" value="<?php echo $q->id ?>" name="id">
                    <fieldset style="display: flex; gap: 1rem;">
                        <legend>Ê§úÂÆö„É¨„Éô„É´„ÅÆÁßªÂãï</legend>
                        <select name="type" style="padding: 1rem; margin: 0; cursor: pointer;">
                            <?php foreach (ExamType::cases() as $type) : ?>
                                <?php if ($type === $this->controller->type) continue ?>
                                <option style="font-size: 21px;" value="<?php echo $type->value ?>"><?php echo $type->value ?></option>
                            <?php endforeach ?>
                        </select>
                        <br>
                        <input type="submit" value="ÁßªÂãï„Åô„Çã" style="padding: 10px 20px; margin: 0;" />
                    </fieldset>
                </form>
                <hr>
                <?php if (!$q->is_admin_user && $q->edit_user_id && ($q->user_id !== $q->edit_user_id)) : ?>
                    <form style="all:unset; display: block;" onsubmit="return confirm('ÂïèÈ°åÁ∑®ÈõÜÊ®©Èôê„ÇíÊäïÁ®øËÄÖ„Å´Êàª„Åó„Åæ„Åô„ÅãÔºü')" method="POST" action="/accreditation/reset-permission-question<?php echo $returnTo ?>">
                        <input type="hidden" value="<?php echo $q->id ?>" name="id">
                        <input type="submit" value="ÂïèÈ°åÁ∑®ÈõÜÊ®©Èôê„ÇíÊäïÁ®øËÄÖ„Å´Êàª„Åô" style="padding: 10px 20px;" />
                    </form>
                <?php endif ?>
            </aside>
        </section>
    <?php
    }

    function questionList(bool $editorMode = false)
    {
        $listLen = count($this->controller->questionList);
        $shareUrl = url("accreditation?id=");

    ?>
        <section style="flex-direction: column;">
            <style>
                .question_paper {
                    margin: 0.5rem 0;
                    width: unset;
                }

                .question_p,
                .question_li span,
                .word-wrap {
                    overflow-wrap: anywhere;
                    white-space: break-spaces;
                    line-break: anywhere;
                }

                .question_p {
                    font-size: 15px;
                }

                .question_li {
                    font-size: 14px;
                    font-weight: bold;
                }

                .question_paper.published {
                    background: var(--color-secondary-accent);
                }

                .share-menu-item {
                    cursor: pointer;
                    width: 24px;
                    height: 24px;
                    display: flex;
                }

                .share-menu-icon {
                    width: 24px;
                    height: 24px;
                    margin: auto;
                    background-repeat: no-repeat;
                    background-size: contain;
                    display: block;
                }

                .share-menu-icon.copy {
                    width: 20px;
                    height: 20px;
                    margin: auto;
                }

                .share-menu-icon-twitter {
                    background-image: url(/assets/twitter_x.svg);
                    background-color: #000000;
                    border-radius: 6px;
                }

                .share-menu-icon-line {
                    background-image: url(/assets/line.svg);
                    border-radius: 6px;
                }

                .copy-btn-icon {
                    background-image: url(/assets/copy_icon_c.svg);
                }

                .question-link-wrap {
                    max-width: 712px;
                    box-sizing: border-box;
                    display: flex;
                    flex-direction: column;
                    gap: 13px;
                    margin-top: 1rem;
                }

                .quession-link-prefix {
                    font-size: 14px;
                    user-select: none;
                    text-wrap: nowrap;
                    font-weight: bold;
                    letter-spacing: -0.3px;
                }

                .question-link {
                    display: -webkit-box;
                    -webkit-box-orient: vertical;
                    -webkit-line-clamp: 2;
                    overflow: hidden;
                    word-break: break-all;
                    font-size: 14px;
                    line-height: 1.3;
                    letter-spacing: -0.3px;
                    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                    text-decoration: unset;
                    font-weight: bold;
                    color: rgb(39, 85, 172);
                }

                @media screen and (min-width: 512px) {
                    .question-link-wrap {
                        gap: 15px;
                    }

                    .question-link {
                        line-height: 1.4;
                        font-size: 15px;
                        font-weight: bold;
                    }
                }

                .question-link-inner {
                    display: flex;
                    flex-direction: row;
                    color: var(--color-text-secondary);
                    gap: 4px;
                    align-items: stretch;
                }

                details {
                    width: 100%;
                }

                details summary {
                    width: fit-content;
                    user-select: none;
                }

                .scroll-to-top {
                    all: unset;
                    display: none;
                    position: fixed;
                    bottom: 10px;
                    right: 10px;
                    width: 36px;
                    height: 36px;
                    background-color: #fff;
                    border-radius: 6px;
                    text-align: center;
                    line-height: 48px;
                    cursor: pointer;
                    box-shadow: 0px 0px 6px -2px #777777;
                    align-items: center;
                    justify-content: center;
                }

                .source-url {
                    display: -webkit-box;
                    -webkit-box-orient: vertical;
                    -webkit-line-clamp: 1;
                    overflow: hidden;
                    word-break: break-all;
                }
            </style>
            <script>
                async function copyUrl(text) {
                    try {
                        await navigator.clipboard.writeText(text)
                        alert("„É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü");
                    } catch {
                        alert("„Ç≥„Éî„Éº„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü\n(ÈùûÂØæÂøú„Éñ„É©„Ç¶„Ç∂)");
                    }
                }
            </script>
            <small style="margin-right: auto; user-select: none; font-size: 15px; color: #000; font-weight: 700;">ÂÖ® <?php echo $listLen ?> ‰ª∂</small>
            <?php if (!$editorMode && $listLen > 1) : ?>
                <details>
                    <summary>ÁõÆÊ¨°„ÇíÈñã„Åè</summary>
                    <div class="question-link-wrap">
                        <?php foreach ($this->controller->questionList as $el) : ?>
                            <div class="question-link-inner">
                                <div class="quession-link-prefix">„Éª</div>
                                <a class="question-link" href="#id-<?php echo $el->id ?>"><?php echo $el->question ?></a>
                            </div>
                        <?php endforeach ?>
                    </div>
                </details>
            <?php endif ?>
            <?php foreach ($this->controller->questionList as $el) : ?>
                <?php $edit = AccreditationUtility::isQuestionEditable($el, $this->controller->myId, $this->controller->isAdmin) ?>

                <aside class="question_paper <?php if ($el->publishing) echo 'published' ?>" id="id-<?php echo $el->id ?>">
                    <div style="display: flex; justify-content: space-between;">
                        <?php if ($el->publishing) : ?>
                            <small style="display: block; font-weight: bold; font-size: 14px;">ÂïèÈ°åID: <?php echo ($el->id) ?>ÔºàÂá∫È°å‰∏≠Ôºâ</small>
                        <?php else : ?>
                            <small style="display: block; font-size: 14px;">ÂïèÈ°åID: <?php echo ($el->id) ?></small>
                        <?php endif ?>
                        <?php if ($edit && !$editorMode) : ?>
                            <a href="./editor?id=<?php echo $el->id ?>">Á∑®ÈõÜ</a>
                        <?php endif ?>
                    </div>
                    <p class="question_p"><?php echo $el->question ?></p>

                    <ol>
                        <?php foreach ([...range('a', 'd')] as $key) : ?>
                            <li type="A" class="question_li">
                                <span><?php echo $el->answersArray[$key] ?? 'Error: ÈÖçÂàó„ÅÆË¶ÅÁ¥†„Åå„ÅÇ„Çä„Åæ„Åõ„Çì' ?></span>
                            </li>
                        <?php endforeach ?>
                    </ol>

                    <p class="question_p"><b>Ê≠£Ëß£: <?php echo strtoupper($el->answersArray['correct'] ?? 'Error: ÈÖçÂàó„ÅÆË¶ÅÁ¥†„Åå„ÅÇ„Çä„Åæ„Åõ„Çì') ?></b></p>
                    <p class="question_p"><?php echo $el->explanationArray['explanation'] ?? 'Error: ÈÖçÂàó„ÅÆË¶ÅÁ¥†„Åå„ÅÇ„Çä„Åæ„Åõ„Çì(explanationArray)' ?></p>

                    <?php if (!isset($el->explanationArray['source_title'], $el->explanationArray['source_url'])) : ?>
                        <p class="question_p">Error: ÈÖçÂàó„ÅÆË¶ÅÁ¥†„Åå„ÅÇ„Çä„Åæ„Åõ„Çì(explanationArray)</p>
                    <?php elseif ($el->explanationArray['source_title'] && $el->explanationArray['source_url']) : ?>
                        <div style="font-size: 14px;">
                            <div class="word-wrap">Âá∫ÂÖ∏URL: <a href="<?php echo $el->explanationArray['source_url'] ?>" target="_blank"><?php echo $el->explanationArray['source_title'] ?> ‚Üó</a></div>
                            <div class="word-wrap"><small style="color: #aaa;" class="source-url"><?php echo $el->explanationArray['source_url'] ?></small></div>
                        </div>
                    <?php elseif ($el->explanationArray['source_url'] === '') : ?>
                        <div style="font-size: 14px;">
                            <div class="word-wrap">Âá∫ÂÖ∏URL: <a href="https://openchat-jp.line.me/other/guideline" target="_blank">ÂÆâÂøÉ„ÉªÂÆâÂÖ®„Ç¨„Ç§„Éâ„É©„Ç§„É≥ | LINE„Ç™„Éº„Éó„É≥„ÉÅ„É£„ÉÉ„Éà ‚Üó</a></div>
                            <div class="word-wrap"><small style="color: #aaa;" class="source-url">https://openchat-jp.line.me/other/guideline</small></div>
                        </div>
                    <?php endif ?>

                    <div style="display: flex; gap: 6px; padding-top: 1rem;">
                        <small style="word-break: keep-all; text-wrap: nowrap;">‰ΩúÊàêËÄÖ</small>

                        <?php if ($el->is_admin_user) : ?>
                            <small style="display: block;">üëë</small>
                        <?php endif ?>

                        <small style="display: block;"><a href="./user?id=<?php echo $el->user_id ?>"><?php echo $el->user_name ?></a></small>
                        <small style="display: block; word-break: keep-all; text-wrap: nowrap;"><?php echo formatDateTimeHourly2($el->created_at, true) ?></small>
                    </div>

                    <?php if ($el->edit_user_id) : ?>
                        <div style="display: flex; gap: 6px; margin-top: 16px;">
                            <small style="word-break: keep-all; text-wrap: nowrap;">ÊúÄÁµÇÊõ¥Êñ∞</small>

                            <?php if ($el->is_admin_edit_user) : ?>
                                <small style="display: block;">üëë</small>
                            <?php endif ?>

                            <small style="display: block;"><a href="./user?id=<?php echo $el->edit_user_id ?>"><?php echo $el->edit_user_name ?></a></small>
                            <small style="display: block; word-break: keep-all; text-wrap: nowrap;"><?php echo formatDateTimeHourly2($el->edited_at, true) ?></small>
                        </div>
                    <?php endif ?>

                    <?php if ($el->isPabulished) : ?>
                        <div style="display: flex; gap: 16px; margin-top: 1rem; flex-wrap: wrap; justify-content: flex-end; align-items: center;">
                            <small style="word-break: keep-all; text-wrap: nowrap;">„Ç∑„Çß„Ç¢</small>

                            <div class="share-menu-item unset" onclick="copyUrl('<?php echo ('„Ç™„Éó„ÉÅ„É£Ê§úÂÆöÔΩúQ.' . $el->id . '\n' . $shareUrl . $el->id) ?>')">
                                <span class="copy-btn-icon share-menu-icon copy"></span>
                            </div>
                            <a class="share-menu-item unset" href="https://twitter.com/intent/tweet?url=<?php echo urlencode($shareUrl . $el->id) ?>&text=<?php echo urlencode($el->question . "\n„Ç™„Éó„ÉÅ„É£Ê§úÂÆöÔΩúQ." . $el->id . "\n") ?>" rel="nofollow noopener" target="_blank" title="„Éù„Çπ„Éà">
                                <span class="share-menu-icon-twitter share-menu-icon"></span>
                            </a>

                            <a class="share-menu-item unset" href="http://line.me/R/msg/text/?<?php echo urlencode('„Ç™„Éó„ÉÅ„É£Ê§úÂÆöÔΩúQ.' . $el->id . "\n" . $shareUrl . $el->id) ?>" rel="nofollow noopener" target="_blank" title="LINE„ÅßÈÄÅ„Çã">
                                <span class="share-menu-icon-line share-menu-icon"></span>
                            </a>
                            <a href="<?php echo $shareUrl . $el->id ?>" target="_blank">Èñã„Åè</a>
                        </div>
                    <?php endif ?>
                </aside>
            <?php endforeach ?>
            <button class="scroll-to-top" id="scrollToTopBtn">
                <svg width="80%" height="80%" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
                    <line x1="16" y1="8" x2="16" y2="24" style="stroke:#000;stroke-width:1.5" />
                    <line x1="16" y1="8" x2="8" y2="16" style="stroke:#000;stroke-width:1.5" />
                    <line x1="16" y1="8" x2="24" y2="16" style="stroke:#000;stroke-width:1.5" />
                </svg>
            </button>
            <script>
                window.onscroll = function() {
                    scrollFunction()
                };

                function scrollFunction() {
                    var scrollToTopBtn = document.getElementById("scrollToTopBtn");
                    if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
                        scrollToTopBtn.style.display = "flex";
                    } else {
                        scrollToTopBtn.style.display = "none";
                    }
                }

                document.getElementById('scrollToTopBtn').addEventListener('click', function() {
                    window.scroll({
                        top: 0,
                        behavior: 'smooth'
                    })
                });
            </script>
        </section>
<?php
    }
}
